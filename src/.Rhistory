plot0 <- ggplot(Data,aes_string(x="maxDepth")) +
annotate(geom = "rect",
xmin = 0,
xmax = 7.5,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[1],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 10,
xmax = 30,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[2],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 50,
xmax = Inf,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[3],
alpha = 0.5) +
geom_histogram(position="identity",binwidth = 0.05)+#bins=100) +
facet_wrap(~Sex,
ncol=1,
strip.position = "top") +
labs(fill = "Dive Type", x = "Maximum dive depth (m)", y = "Number of dives") +
scale_x_log10(breaks = c(seq(0.5,0.9,0.1),seq(1,9,1),seq(10,90,10),seq(100,400,100)),
labels = c(rep("",5),1,rep("",8),10,rep("",8),100,rep("",3))) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
#annotation_logticks(sides = "b") +
theme_classic() +
theme(strip.background = element_blank(),
strip.text.x = element_blank(),
text = element_text(size=16)) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=30,xmax=40,ymin=-Inf,ymax=Inf,fill="Deep"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=40,xmax=50,ymin=-Inf,ymax=Inf,fill="Medium"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=50,xmax=60,ymin=-Inf,ymax=Inf,fill="Shalow"),alpha=0.005) +
scale_fill_manual('Dive labels',
values = c("#007094","#00BE7D","#FDE333"),
guide = guide_legend(override.aes = list(alpha = 0.2))) +
geom_text(data = data.frame(Sex = c("Female","Male"),
x = c(0.5,0.5),
y = c(400,400),
label = c("A) Females","B) Males")),
aes(x=x,y=y,label=label),
size = 6, hjust=0, vjust=1, fontface = "bold")
print(plot0)
plot0 <- ggplot(Data,aes_string(x="maxDepth")) +
annotate(geom = "rect",
xmin = 0,
xmax = 7.5,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[1],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 10,
xmax = 30,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[2],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 50,
xmax = Inf,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[3],
alpha = 0.5) +
geom_histogram(position="identity",binwidth = 0.05)+#bins=100) +
facet_wrap(~Sex,
ncol=1,
strip.position = "top") +
labs(fill = "Dive Type", x = "Maximum dive depth (m)", y = "Number of dives") +
scale_x_log10(breaks = c(seq(0.5,0.9,0.1),seq(1,9,1),seq(10,90,10),seq(100,400,100)),
labels = c(rep("",5),1,rep("",8),10,rep("",8),100,rep("",3))) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
#annotation_logticks(sides = "b") +
theme_classic() +
theme(strip.background = element_blank(),
strip.text.x = element_blank(),
text = element_text(size=16)) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=30,xmax=40,ymin=-Inf,ymax=Inf,fill="Deep"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=40,xmax=50,ymin=-Inf,ymax=Inf,fill="Medium"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=50,xmax=60,ymin=-Inf,ymax=Inf,fill="Shalow"),alpha=0.005) +
scale_fill_manual('Dive labels',
values = c("#007094","#00BE7D","#FDE333"),
breaks = c("Shallow","Medium","Deep"),
guide = guide_legend(override.aes = list(alpha = 0.2))) +
geom_text(data = data.frame(Sex = c("Female","Male"),
x = c(0.5,0.5),
y = c(400,400),
label = c("A) Females","B) Males")),
aes(x=x,y=y,label=label),
size = 6, hjust=0, vjust=1, fontface = "bold")
print(plot0)
plot0 <- ggplot(Data,aes_string(x="maxDepth")) +
annotate(geom = "rect",
xmin = 0,
xmax = 7.5,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[1],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 10,
xmax = 30,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[2],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 50,
xmax = Inf,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[3],
alpha = 0.5) +
geom_histogram(position="identity",binwidth = 0.05)+#bins=100) +
facet_wrap(~Sex,
ncol=1,
strip.position = "top") +
labs(fill = "Dive Type", x = "Maximum dive depth (m)", y = "Number of dives") +
scale_x_log10(breaks = c(seq(0.5,0.9,0.1),seq(1,9,1),seq(10,90,10),seq(100,400,100)),
labels = c(rep("",5),1,rep("",8),10,rep("",8),100,rep("",3))) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
#annotation_logticks(sides = "b") +
theme_classic() +
theme(strip.background = element_blank(),
strip.text.x = element_blank(),
text = element_text(size=16)) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=30,xmax=40,ymin=-Inf,ymax=Inf,fill="Shallow"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=40,xmax=50,ymin=-Inf,ymax=Inf,fill="Medium"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=50,xmax=60,ymin=-Inf,ymax=Inf,fill="Deep"),alpha=0.005) +
scale_fill_manual('Dive labels',
values = c("#007094","#00BE7D","#FDE333"),
breaks = c("Shallow","Medium","Deep"),
guide = guide_legend(override.aes = list(alpha = 0.2))) +
geom_text(data = data.frame(Sex = c("Female","Male"),
x = c(0.5,0.5),
y = c(400,400),
label = c("A) Females","B) Males")),
aes(x=x,y=y,label=label),
size = 6, hjust=0, vjust=1, fontface = "bold")
print(plot0)
ggsave(paste0("../plots/",date,"/hist_maxDepth.png"),
plot = plot0,
width = 8,
height = 4,
device='png',
dpi=500)
library(momentuHMM)
library(circular)
library(CircStats)
library(runner)
library(ggplot2)
library(tidyr)
library(dplyr)
library(mclust)
library(mixreg)
library(readxl)
library(diveMove)
library(boot)
library(data.table)
library(party)
library(numDeriv)
library(data.tree)
library(scales)
library(gridExtra)
# define parameters
sex <- "Male"
date <- "2023-04-03"
holdout_whale <- "None"
nseeds <- 1
N_coarse <- 3
N_fine <- 4
N <- N_coarse * N_fine
### Load Data ###
setwd("~/Documents/Research/PHMM/src")
# load data
Data <- data.frame(fread('../../dat/Final_Data_Beth.csv'))
ethogram <- data.frame(fread('../../dat/Final_ethogram_Beth.csv'))
# get post dive int
#Data[is.infinite(Data$postDiveInt),"postDiveInt"] <- NA
# turn data positive for gamma dists
Data$postDiveInt <- exp(Data$postDiveInt) + runif(nrow(Data))/2
Data$maxDepth <- exp(Data$maxDepth)
Data$diveDuration <- exp(Data$diveDuration) + runif(nrow(Data))/2
# change post-diveinterval to a categorical
Data$postDiveIntCat <- 0
Data$postDiveIntCat <- Data$postDiveIntCat + (Data$postDiveInt < 10)
Data$postDiveIntCat <- Data$postDiveIntCat + (Data$postDiveInt < 5)
Data$postDiveIntCat <- Data$postDiveIntCat + (Data$postDiveInt < 2)
Data$postDiveIntCat <- factor(Data$postDiveIntCat)
# make wiggliness a log-scale
Data$avg_w_low <- log(Data$avg_w_low)
Data$avg_w_high <- log(Data$avg_w_high)
# turn dive Type into a factor
Data$diveType <- factor(Data$diveType,
levels = c("Resting", "Travelling", "Foraging", "Logging"))
Data$diveType <- addNA(Data$diveType)
Data[!is.na(Data$postDiveInt) &
Data$postDiveInt >= 10,"diveType"] <- "Logging"
### Label Deep vs Shallow Dives ###
shallow_thresh <- c(0,7.5)
medium_thresh <- c(10,30)
deep_thresh <- c(50,Inf)
Data$broadDiveType <- NA
Data$broadDiveType[(shallow_thresh[1] < Data$maxDepth) & (Data$maxDepth < shallow_thresh[2])] <- 1
Data$broadDiveType[(medium_thresh[1] < Data$maxDepth) & (Data$maxDepth < medium_thresh[2])] <- 2
Data$broadDiveType[(deep_thresh[1] < Data$maxDepth) & (Data$maxDepth < deep_thresh[2])] <- 3
Data$broadDiveType[Data$diveType %in% "Logging"] <- 4
Data$broadDiveType[is.na(Data$broadDiveType)] <- 5
### add label to next deep dive for foraging dives
# deep dives mean foraging
Data[Data$broadDiveType %in% 3,"diveType"] <- "Foraging"
# deep-ish dives after labels mean foraging too
for(stime in Data$stime[Data$diveType %in% "Foraging"]){
future_dives <- Data[(Data$stime >= stime) & (Data$stime < stime + 120),]
future_deep_dives <- future_dives[future_dives$maxDepth > 30,]
if(nrow(future_deep_dives) >= 1){
dive_ind <- rownames(future_deep_dives)[1]
Data[dive_ind,"diveType"] <- "Foraging"
}
}
### Label knownStates ###
Data$knownState <- NA
Data$knownState[Data$diveType %in% "Resting"] <- 1
Data$knownState[Data$diveType %in% "Travelling"] <- 2
Data$knownState[Data$diveType %in% "Foraging"] <- 3
Data$knownState[is.na(Data$knownState)] <- 4
span <- 10 # minutes
### change to hierarchical ###
Data0 <- NULL
for(ID in unique(Data$ID)){
boutnum <- 1
whale_data <- Data[Data$ID %in% ID,]
start <- whale_data$stime[1]
end <- whale_data$etime[nrow(whale_data)]
time <- start
while(time < end){
# add levels 1 and 2i
tmp1 <- as.data.frame(matrix(nrow=2,ncol=ncol(Data)+1))
colnames(tmp1) <- c("boutnum",colnames(Data))
tmp1$ID <- ID
tmp1$level <- c("1","2i")
# add level 2
tmp2 <- whale_data[(whale_data$stime >= time) & (whale_data$stime < (time + span*60)),]
rest <- any(c(1) %in% tmp2$knownState)
trav <- any(c(2) %in% tmp2$knownState)
forg <- any(c(3) %in% tmp2$knownState)
# check for repeated knownState
if(forg){
tmp2$knownState <- 3
}
else if (rest + trav > 1){
tmp2$knownState <- 4
}
if(nrow(tmp2) > 0){
# combine it all together
tmp2$level <- "2"
tmp1$boutnum <- boutnum
tmp2$boutnum <- boutnum
boutnum <- boutnum + 1
Data0 <- rbind(Data0,tmp1,tmp2)
}
# move the current time
time <- tail(tmp2,n=1)[1,"etime"]
}
}
Data <- Data0
rownames(Data) <- 1:nrow(Data)
### add sex to Data ###
Data$Sex <- "Female"
Data[Data0$ID %in% c("I107","D21","L87","L88"),"Sex"]  <- "Male"
Data$Sex <- factor(Data$Sex)
Data <- prepData(Data,
coordNames=NULL,
hierLevels = c("1", "2i", "2"))
group.colors.coarse <- c("1" = "#F8766D",
"2" = "#7CAE00",
"3" = "#00BFC4")
group.colors.fine <- c("1" = "#007094",
"2" = "#00BE7D",
"3" = "#FDE333",
"4" = "#C77CFF")
### plot histogram of depths by sex ###
Data$maxDepth[Data$ID == "D21"] <- Data$maxDepth[Data$ID == "D21"] + 0.5
plot0 <- ggplot(Data,aes_string(x="maxDepth")) +
annotate(geom = "rect",
xmin = 0,
xmax = 7.5,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[1],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 10,
xmax = 30,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[2],
alpha = 0.5) +
annotate(geom = "rect",
xmin = 50,
xmax = Inf,
ymin = -Inf,
ymax = Inf,
fill = group.colors.fine[3],
alpha = 0.5) +
geom_histogram(position="identity",binwidth = 0.05)+#bins=100) +
facet_wrap(~Sex,
ncol=1,
strip.position = "top") +
labs(fill = "Dive Type", x = "Maximum dive depth (m)", y = "Number of dives") +
scale_x_log10(breaks = c(seq(0.5,0.9,0.1),seq(1,9,1),seq(10,90,10),seq(100,400,100)),
labels = c(rep("",5),1,rep("",8),10,rep("",8),100,rep("",3))) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +
#annotation_logticks(sides = "b") +
theme_classic() +
theme(strip.background = element_blank(),
strip.text.x = element_blank(),
text = element_text(size=16)) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=30,xmax=40,ymin=-Inf,ymax=Inf,fill="Shallow"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=40,xmax=50,ymin=-Inf,ymax=Inf,fill="Medium"),alpha=0.005) +
geom_rect(data = data.frame(maxDepth = 0, y = 0), aes(xmin=50,xmax=60,ymin=-Inf,ymax=Inf,fill="Deep"),alpha=0.005) +
scale_fill_manual('Dive labels',
values = c("#007094","#00BE7D","#FDE333"),
breaks = c("Shallow","Medium","Deep"),
guide = guide_legend(override.aes = list(alpha = 0.2))) +
geom_text(data = data.frame(Sex = c("Female","Male"),
x = c(0.5,0.5),
y = c(400,400),
label = c("A) Females","B) Males")),
aes(x=x,y=y,label=label),
size = 6, hjust=0, vjust=1, fontface = "bold")
print(plot0)
ggsave(paste0("../plots/",date,"/hist_maxDepth.png"),
plot = plot0,
width = 8,
height = 4,
device='png',
dpi=500)
# Do some small EDA
if (sex == "Male"){
Data <- Data[Data$Sex %in% "Male",]
} else {
Data <- Data[Data$Sex %in% "Female",]
}
# select the best model
best_hhmm <- NULL
max_like <- -Inf
for(rand_seed in 1:nseeds){
hhmm <- readRDS(paste0("../params/",date,"/hierHmm_",
holdout_whale,"_",
sex,"_",
rand_seed,".rds"))
print(rand_seed)
print(hhmm)
if (-hhmm$mod$minimum > max_like){
best_hhmm <- hhmm
max_like <- -hhmm$mod$minimum
}
}
hhmm <- best_hhmm
print(hhmm)
# define dive types
group.names <- c("1" = "Resting (Shallow)",
"2" = "Resting (Medium)",
"3" = "Resting (Deep)",
"4" = "Resting (Logging)",
"5" = "Travelling (Shallow)",
"6" = "Travelling (Medium)",
"7" = "Travelling (Deep)",
"8" = "Travelling (Logging)",
"9" = "Foraging (Shallow)",
"10" = "Foraging (Medium)",
"11" = "Foraging (Deep)",
"12" = "Foraging (Logging)")
group.names.coarse <- c("1" = "Resting",
"2" = "Travelling",
"3" = "Foraging")
group.names.fine <- c("1" = "Shallow",
"2" = "Medium",
"3" = "Deep",
"4" = "Logging")
# decode vitirbi
vstates <- viterbi(hhmm)
vstates_fine <- rep(NA,length(vstates))
vstates_fine[vstates %in% c(1,5,9)] <- 1
vstates_fine[vstates %in% c(2,6,10)] <- 2
vstates_fine[vstates %in% c(3,7,11)] <- 3
vstates_fine[vstates %in% c(4,8,12)] <- 4
vstates_coarse <- rep(NA,length(vstates))
vstates_coarse[vstates %in% c(1,2,3,4)] <- 1
vstates_coarse[vstates %in% c(5,6,7,8)] <- 2
vstates_coarse[vstates %in% c(9,10,11,12)] <- 3
fb <- stateProbs(hhmm)
colnames(fb) <- group.names
# add dive types to unlabelled and labelled Data
Data$vstate1 <- vstates
Data$vstate1_coarse <- vstates_coarse
Data$vstate1_fine <- vstates_fine
Data <- left_join(Data,
data.frame(vstate1=1:N,vdivetype=group.names),
by="vstate1")
Data <- cbind(Data,fb)
# add the dive types to the RawData
dive_types <- data.frame(vstate1 = vstates,
vstate1_coarse = vstates_coarse,
vstate1_fine = vstates_fine,
divenum = Data$divenum,
knownState = Data$knownState)
# load in the rawData
rawData <- data.frame(fread('../../dat/Final_rawData_Beth.csv'))
rawData <- rawData[,!(names(rawData) %in% c("vstate1","label1"))]
rawData <- left_join(rawData,dive_types,by="divenum")
rawData <- rawData[,!(names(rawData) %in% c("diveType"))]
rawData <- left_join(rawData,Data[,c("divenum","diveType")],by="divenum")
rawData$Elevation <- -rawData$p
cols_to_plot <- c("Elevation")#,"w_low","w_high")
labs <- c(Elevation = "Depth (meters)",
head = "Heading (degrees)",
roll = "Roll (degrees)",
pitch = "Pitch (degrees)",
jp = "Jerk Peak (m/s^3)",
htv = "Heading Total Variation",
w_low = "wiggliness (< 5 Hz)",
w_high = "wiggliness (>= 5 Hz)",
avg_w_low = "Average Wiggliness (< 5 Hz)",
avg_w_high = "Average Wiggliness (>= 5 Hz)",
Aw_1 = "x-acc (m/s^2)",
Aw_2 = "y-acc (m/s^2)",
Aw_3 = "z-acc (m/s^2)",
maxDepth = "Maximum Depth (m)",
diveDuration = "Dive Duration (s)",
postDiveInt = "Post Dive Interval (s)",
max_bot_jp = "log(Bottom Peak Jerk (m/s^3))",
avg_bot_htv = "log(Average Heading Variation Rate at Bottom (rad/s))",
avg_bot_abs_roll = "log(Average Absolute Roll at Bottom (rad))")
rawDataDownLong <- rawData[seq(1,nrow(rawData),10),] %>%
pivot_longer(cols = cols_to_plot,
names_to = "feature")
# plot the results
group.colors.coarse <- c("1" = "#F8766D",
"2" = "#7CAE00",
"3" = "#00BFC4")
group.colors.fine <- c("1" = "#007094",
"2" = "#00BE7D",
"3" = "#FDE333",
"4" = "#C77CFF")
### plot data
for (whale in c("D21")){#unique(Data$ID)){
dives = Data[(Data$ID %in% whale),]$divenum
df <- rawDataDownLong[(rawDataDownLong$divenum %in% dives) &
(rawDataDownLong$segnum != 0),]
df$Time <- (df$Time - min(df$Time))/3600
plot1 <- ggplot(df,aes(x=Time, y=value)) +
geom_line(aes(color=factor(vstate1_fine),
group=divenum)) +
geom_hline(yintercept = 0) +
scale_color_manual(labels=group.names.fine,
values=group.colors.fine) +
labs(color="",
y="Dive depth (m)",
x="") +
scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
annotate(geom = "text",
label = "A) Dive type",
x = min(df$Time) + 0.05*(max(df$Time) - min(df$Time)),
y = -50,
size = 6, hjust=0, vjust=1, fontface = "bold") +
theme_classic() +
theme(strip.background = element_blank(),
strip.placement = "outside",
legend.position = c(.1,.3),
legend.justification = "left",
text = element_text(size=16)) +
guides(colour = guide_legend(override.aes = list(linewidth=3)))
plot2 <- ggplot(df,aes(x=Time, y=value)) +
geom_line(aes(color=factor(vstate1_coarse),
group=divenum)) +
geom_hline(yintercept = 0) +
scale_color_manual(labels=group.names.coarse,
values=group.colors.coarse) +
labs(color="",
y="Dive depth (m)",
x="Elapsed time (hours)") +
scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
annotate(geom = "text",
label = "B) Behavioural state",
x = min(df$Time) + 0.05*(max(df$Time) - min(df$Time)),
y = -50,
size = 6, hjust=0, vjust=1, fontface = "bold") +
theme_classic() +
theme(strip.background = element_blank(),
strip.placement = "outside",
legend.position=c(.1,.3),
legend.justification = "left",
text = element_text(size=16)) +
guides(colour = guide_legend(override.aes = list(linewidth=3)))
g <- arrangeGrob(plot1, plot2)
ggsave(paste0("../plots/",date,"/profile_",whale,"_all.png"),
plot = g,
width = 8,
height = 8,
device='png',
dpi=500)
}
